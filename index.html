<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fenerbahçe - Galatasaray Koltuk Seçimi</title>
  <style>
    /* Tüm stil tanımları aynı kalabilir, çünkü görsel yapı zaten çok başarılı */
    /* ... (stil kısmını istersen sadeleştirebiliriz) */
  </style>
</head>
<body>
  <!-- Arayüz kısmı aynı kalıyor -->
  <!-- ... -->

<script>
const SHEET_URL = "https://script.google.com/macros/s/AKfycbwwEXlcgVNbx3bAwfDzpuxcIsAITYneokStmNV4EgtOQXwhVAXUphiKJRsHKtqQfg5L/exec";

const rows = 10;
const cols = 15;
const letters = "ABCDEFGHIJ".split("");
const grid = document.getElementById("grid");
const selectedListEl = document.getElementById("selectedList");
const statusEl = document.getElementById("status");
const saveBtn = document.getElementById("saveBtn");
const clearBtn = document.getElementById("clearBtn");

let selected = new Set();
let reserved = new Set();

function seatId(r,c){ return `${letters[r]}${c}`; }

function buildSeats(){
  grid.innerHTML = '';
  for (let r = 0; r < rows; r++){
    for (let c = 1; c <= cols; c++){
      const id = seatId(r,c);
      const el = document.createElement("div");
      el.className = 'seat';
      el.dataset.id = id;
      el.textContent = id;
      el.title = id;

      if (r === 0 && c >= 4 && c <= 12) {
        el.classList.add('reserved');
        reserved.add(id);
      }

      el.addEventListener('click', () => onSeatClick(el));
      grid.appendChild(el);
    }
  }
  refreshUI();
}

function onSeatClick(el){
  const id = el.dataset.id;
  if (reserved.has(id)) return;
  if (selected.has(id)) {
    selected.delete(id);
    el.classList.remove('selected');
  } else {
    selected.add(id);
    el.classList.add('selected');
  }
  updateSelectedList();
}

function updateSelectedList(){
  selectedListEl.textContent = selected.size === 0
    ? 'Henüz koltuk seçmediniz.'
    : Array.from(selected).join(', ');
}

function refreshUI(){
  document.querySelectorAll('.seat').forEach(el=>{
    const id = el.dataset.id;
    el.classList.remove('selected');
    el.classList.toggle('reserved', reserved.has(id));
  });
  for (let s of Array.from(selected)){
    if (reserved.has(s)) selected.delete(s);
  }
  updateSelectedList();
}

async function loadReservedFromSheet(){
  statusEl.textContent = 'Sunucudan dolu koltuklar çekiliyor...';
  try {
    const res = await fetch(SHEET_URL);
    if (!res.ok) throw new Error('Sunucu yanıt vermedi: ' + res.status);
    const data = await res.json();
    const kolKey = Object.keys(data[0] || {}).find(k => k.toLowerCase().includes('kol'));
    const durKey = Object.keys(data[0] || {}).find(k => k.toLowerCase().includes('dur'));
    reserved = new Set();
    for (let c=4;c<=12;c++) reserved.add(`A${c}`);
    if (Array.isArray(data)){
      data.forEach(row => {
        const seat = kolKey ? row[kolKey] : row['Koltuk'];
        const durum = durKey ? row[durKey] : row['Durum'];
        if (!seat) return;
        if (String(durum).toUpperCase() === 'DOLU') {
          reserved.add(String(seat).trim());
        }
      });
    }
    refreshUI();
    statusEl.textContent = 'Güncel durum yüklendi.';
  } catch (err){
    console.error("Hata oluştu:", err);
    statusEl.textContent = 'Sunucuya bağlanırken hata. (Çevrimdışı demo çalışır)';
  }
}

async function saveSelectedToSheet(){
  if (selected.size === 0){
    alert('Önce en az bir koltuk seçin.');
    return;
  }
  saveBtn.disabled = true;
  saveBtn.textContent = 'Kaydediliyor...';

  const toSave = Array.from(selected);

  try {
    for (const s of toSave){
      const payload = { koltuk: s, durum: 'DOLU' };
      const res = await fetch(SHEET_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error('Kaydetme başarısız: ' + res.status);
      await new Promise(res => setTimeout(res, 150));
    }
    await loadReservedFromSheet();
    selected.clear();
    updateSelectedList();
    alert('Seçiminiz kaydedildi. (Google Sheet güncellendi)');
  } catch (err){
    console.error("Kayıt hatası:", err);
    alert('Kaydetme sırasında hata oluştu. Konsolu kontrol edin.');
  } finally {
    saveBtn.disabled = false;
    saveBtn.textContent = 'Kaydet';
  }
}

function clearSelection(){
  selected.clear();
  document.querySelectorAll('.seat.selected').forEach(el=>el.classList.remove('selected'));
  updateSelectedList();
}

buildSeats();
loadReservedFromSheet();
saveBtn.addEventListener('click', saveSelectedToSheet);
clearBtn.addEventListener('click', clearSelection);
setInterval(loadReservedFromSheet, 20000);
</script>
</body>
</html>
